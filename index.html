local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TextChatService = game:GetService("TextChatService")
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

local SetAFKStatus = ReplicatedStorage:WaitForChild("SetAFKStatus")
local LocalPlayer = Players.LocalPlayer

local AUTO_AFK_DELAY = 300         -- ??????
local MOVE_THRESHOLD = 1
local TOGGLE_KEY = Enum.KeyCode.G  -- ???????? AFK

local isAFK, manualAFK = false, false
local lastActiveTime, lastPosition = os.clock(), nil
local lastSent = nil
local lastAFKToggle = 0

-- ??????????????? AFK
local function setAFK(newState)
	if isAFK ~= newState then
		isAFK = newState
		if lastSent ~= isAFK then
			SetAFKStatus:FireServer(isAFK)
			lastSent = isAFK
		end
	end
end

-- ?????????? activity
local function resetTimer()
	lastActiveTime = os.clock()
	if isAFK and not manualAFK then
		setAFK(false)
	end
end

-- ???? manual AFK
local function toggleManual()
	manualAFK = not manualAFK
	setAFK(manualAFK)
	if not manualAFK then
		resetTimer()
	end
end

-- ??? input
UserInputService.InputBegan:Connect(function(input, processed)
	if processed then return end
	if input.KeyCode == TOGGLE_KEY then
		toggleManual()
	elseif not manualAFK then
		resetTimer()
	end
end)

UserInputService.InputChanged:Connect(function()
	if not manualAFK then
		resetTimer()
	end
end)

-- ?????? /afk
TextChatService.OnIncomingMessage = function(message)
	-- ?????????????????? manualAFK ????????
	if manualAFK then return end

	if message.TextSource and message.TextSource.UserId == LocalPlayer.UserId then
		local text = message.Text:lower()

		if text:match("^/afk") then
			-- ??? spam toggle ????
			if os.clock() - lastAFKToggle > 0.3 then
				toggleManual()
				lastAFKToggle = os.clock()
			end
			return -- ??????????????????? ??? resetTimer ????????
		end

		-- ????????? manualAFK ?????????
		resetTimer()
	end
end

-- ????????????????????
LocalPlayer.CharacterAdded:Connect(function(char)
	char:WaitForChild("HumanoidRootPart")
	lastPosition = char.HumanoidRootPart.Position
end)

-- ????????/?????????????
RunService.Heartbeat:Connect(function()
	if manualAFK then return end

	local char = LocalPlayer.Character
	if char and char:FindFirstChild("HumanoidRootPart") then
		local pos = char.HumanoidRootPart.Position
		if lastPosition and (pos - lastPosition).Magnitude > MOVE_THRESHOLD then
			resetTimer()
		end
		lastPosition = pos
	end

	if os.clock() - lastActiveTime > AUTO_AFK_DELAY then
		setAFK(true)
	end
end)
